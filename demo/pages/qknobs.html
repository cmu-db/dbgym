<head>
    <meta charset="UTF-8">
    <title>Query Knobs</title>
    <link rel="stylesheet" type="text/css" href="../css/style.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        .container {
            display: flex;
            height: 100%;
        }
        .sidebar {
            width: 200px;
            background-color: #c41230;
            display: flex;
            flex-direction: column;
        }
        .table-container {
            flex-grow: 1;
            padding: 10px;
            margin-left: 20px;
        }
        .query-button {
            display: block;
            padding: 20px;
            border: none;
            box-shadow: none;
            background-color: #c41230;
            font-size: 16px;
            font-weight: bold;
            color: white;
        }
        .query-button:hover {
            background-color: #d2435a;
        }
        .active-button {
            background-color: white;
            color: black;
        }
    </style>
    <script>
        let activeButton = null; // Track the currently active button

        function updateTable(data, button) {
            // Update the table content based on the button pressed
            const tableBody = document.getElementById('table-body');
            const tableTitle = document.getElementById('table-title'); // Get the title element
            tableBody.innerHTML = ''; // Clear existing rows

            tableTitle.textContent = `Query ${button.textContent.split(' ')[1]} Knobs`; // Update title

            const userData = JSON.parse(localStorage.getItem('userData')) || { qknobs: {} }; // Retrieve userData

            data.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach((cell, index) => {
                    const td = document.createElement('td');
                    if (index === 2) { // Check if it's the third column
                        const select = document.createElement('select');
                        // Add options to the select element from the cell array
                        cell.forEach(optionText => {
                            const option = document.createElement('option');
                            option.textContent = optionText;
                            select.appendChild(option);
                        });
                        // Set the selected value based on userData
                        const knobName = row[0]; // Assuming the first column is the knob name
                        const query = "query" + button.textContent.split(' ')[1].toLowerCase(); // Get the query number
                        if (userData.qknobs[query] && userData.qknobs[query][knobName]) {
                            select.value = userData.qknobs[query][knobName]; // Set the selected value
                        }
                        // Add event listener to log selected knob when changed
                        select.addEventListener('change', () => {
                            const selectedKnobs = Array.from(tableBody.querySelectorAll('select')).map(select => select.value);
                            console.log("Currently selected knobs:", selectedKnobs);

                            // Update local storage with the new value
                            const knobName = row[0]; // Assuming the first column is the knob name
                            const query = "query" + button.textContent.split(' ')[1].toLowerCase(); // Get the query number (query1, query2, etc.)
                            updateUserData(query, knobName, select.value);
                        });
                        td.appendChild(select);
                    } else {
                        td.textContent = cell;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            // Highlight the active button
            const buttons = document.querySelectorAll('.query-button');
            buttons.forEach(btn => {
                btn.classList.remove('active-button');
                btn.style.backgroundColor = ''; // Reset background color
            });

            button.classList.add('active-button');
            button.style.backgroundColor = 'white'; // Set active button color
            activeButton = button; // Update the active button reference
        }

        const queriesKnobData = {
            query1: [
                ['enable_nestloop', 'ON', ['ON', 'OFF']],
                ['enable_hashjoin', 'ON', ['ON', 'OFF']]
            ],
            query2: [
                ['enable_seqscan', 'OFF', ['ON', 'OFF']],
                ['enable_hashjoin', 'ON', ['ON', 'OFF']]
            ],
            query3: [
                ['enable_nestloop', 'ON', ['ON', 'OFF']],
                ['enable_seqscan', 'OFF', ['ON', 'OFF']]
            ]
        }

        function query1Click() {
            updateTable(queriesKnobData.query1, document.getElementById('query1'));
        }

        function query2Click() {
            updateTable(queriesKnobData.query2, document.getElementById('query2'));
        }

        function query3Click() {
            updateTable(queriesKnobData.query3, document.getElementById('query3'));
        }

        // Call query1Click on page load
        window.onload = function() {
            updateUserDataOnLoad();
            query1Click();
        };

        // New function to update userData based on default values
        function updateUserDataOnLoad() {
            Object.keys(queriesKnobData).forEach(query => {
                const defaultData = queriesKnobData[query]; // Use queriesKnobData for default values
                const userData = JSON.parse(localStorage.getItem('userData'));

                if (!userData.qknobs) {
                    userData.qknobs = {};
                }

                if (!userData.qknobs[query]) {
                    userData.qknobs[query] = {};
                }

                defaultData.forEach(([knobName, defaultValue]) => {
                    userData.qknobs[query][knobName] = defaultValue; // Set default values
                });

                localStorage.setItem('userData', JSON.stringify(userData)); // Save updated userData
            });
        }

        // Add this function to update local storage
        function updateUserData(query, knobName, value) {
            const userData = JSON.parse(localStorage.getItem('userData')) || { qknobs: {} };
            if (!userData.qknobs[query]) {
                userData.qknobs[query] = {};
            }
            userData.qknobs[query][knobName] = value;
            localStorage.setItem('userData', JSON.stringify(userData));
        }
    </script>
</head>

<body>
    <div class="header-bar">
        <h1>Per-Query Knobs</h1>
        <button class="next-button" onclick="window.location.href='leaderboard.html'">Run Workload â†’</button>
    </div>

    <div class="container">
        <div class="sidebar">
            <button id="query1" class="query-button" onclick="query1Click()">Query 1</button>
            <button id="query2" class="query-button" onclick="query2Click()">Query 2</button>
            <button id="query3" class="query-button" onclick="query3Click()">Query 3</button>
        </div>
        <div class="table-container">
            <h3 id="table-title">Query 1 Knobs</h3>
            <table>
                <thead>
                    <tr>
                        <th>Knob</th>
                        <th>Default</th>
                        <th>Current</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                </tbody>
            </table>
        </div>
    </div>

    <div id="popupContainer">
        <script>
            fetch('../components/popup.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('popupContainer').innerHTML = data;
                })
                .catch(error => console.error("Error loading popup:", error));
        </script>
        <script src="../js/loadPopupHtml.js"></script>
    </div>

    <!-- <div id="printJsonButtonContainer">
        <script>
            fetch('../components/printJsonButton.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('printJsonButtonContainer').innerHTML = data;
                })
                .catch(error => console.error("Error loading popup:", error));
        </script>
    </div> -->
</body>